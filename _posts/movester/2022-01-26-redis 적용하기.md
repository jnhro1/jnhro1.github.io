---
layout: post
title: "redis ì ìš©í•˜ê¸°"
subtitle: "redis"
categories: MOVESTER
tags: BACKEND
comments: true
---

- ëª©ì°¨
  - [1. redis ë€?](#)
  - [2. redis ì¥ì ](#)
  - [3. redis ë‹¨ì ](#)
  - [4. ë­…ìŠ¤í„° ì ìš©í•˜ê¸°](#)


<br>

Redis ì— ëŒ€í•´ì„œëŠ” ì§€ë‚œ í¬ìŠ¤íŒ…ì—ì„œ ê°„ë‹¨íˆ ë‹¤ë£¬ê²Œ ìˆë‹¤ [(WEB) Redis](https://jnhro1.github.io/web/2021/06/08/Redis.html) <br>
ë³µìŠµí•  ê²¸ Redisì— ëŒ€í•´ ë‹¤ì‹œ ì•Œì•„ë³´ê³ , ë­…ìŠ¤í„°ì— ì ìš©í•´ë³´ì.ğŸ‘<br>

## 1. redis ë€?

- Remote Dictionary Serverì˜ ì•½ì–´
- ë©”ëª¨ë¦¬ ê¸°ë°˜ì˜ key-value Store
- Cassandraë‚˜ HBaseì™€ ê°™ì´ NoSQL DBMSë¡œ ë¶„ë¥˜
- ë˜í•œ memcachedì™€ ê°™ì€ In memory ì†”ë£¨ì…˜ìœ¼ë¡œ ë¶„ë¥˜ë˜ê¸°ë„ í•¨

<br><br>

## 2. redis ì¥ì 

- ë¨ìƒ(ì¸ë©”ëª¨ë¦¬ìºì‹œìƒ)ì—ì„œ ë°ì´í„°ë¥¼ ì •ì˜í•˜ì—¬ ê¸°ì¡´ì˜ í•˜ë“œë””ìŠ¤í¬ì—ì„œ ë°ì´í„°ë¥¼ ì ‘ê·¼í•˜ëŠ” ê²ƒë³´ë‹¤ ë§¤ìš° ë¹ ë¥¸ ì‹¤í–‰ ì†ë„ë¥¼ ë³´ì¥ë°›ì„ ìˆ˜ ìˆë‹¤.
- ë°ì´í„°ë¥¼ dbì— ì €ì¥í•˜ì—¬ ì„œë²„ì™€ í†µì‹ í•œ ë’¤ ê·¸ ë°ì´í„°ë¥¼ í™•ì¸í•˜ëŠ” ê²ƒë³´ë‹¤ ramì— ì €ì¥í•¨ìœ¼ë¡œì¨ ì‹œê°„ì„ ë‹¨ì¶•ì‹œí‚¬ ìˆ˜ ìˆë‹¤.

<br><br>

## 3. redis ë‹¨ì 

- redis ì„œë²„ê°€ ì´ˆê¸°í™”ë˜ë©´ redisì— ì €ì¥ëœ ë°ì´í„°ê°€ ëª¨ë‘ ì´ˆê¸°í™”ëœë‹¤.
- ë•Œë¬¸ì— ì¤‘ìš”í•œ ì •ë³´, ì‚­ì œë˜ë©´ ì•ˆë˜ëŠ” ë°ì´í„°ëŠ” ì‚¬ìš©í•˜ë©´ ì•ˆëœë‹¤.

<br><br>

## 4. ë­…ìŠ¤í„° ì ìš©í•˜ê¸°

ìœ„ì˜ ì¥ë‹´ì ìœ¼ë¡œ RedisëŠ” ë³´í†µ ì„¸ì…˜ ì •ë³´ë¥¼ ì €ì¥í•˜ëŠ”ë° ê°€ì¥ ë§ì´ ì“°ì¸ë‹¤.<br>
ë­…ìŠ¤í„°ë„ ì§€ë‚œ ì‹œê°„ì— jwt ë¥¼ í†µí•´ ë°œê¸‰ë°›ì€ refreshTokenì€ redisì— ì €ì¥í•˜ì—¬ ì‚¬ìš©í•  ê²ƒì´ë‹¤.<br><br>

ì´ì œ ì½”ë“œë¥¼ ì‚´í´ë³´ì. ğŸ˜„<br><br>

### redis ì„¤ì¹˜ ë° ì„¸íŒ…

`npm install --save redis`
í•´ë‹¹ ëª…ë ¹ì–´ë¥¼ í†µí•´ redisë¥¼ ì„¤ì¹˜í•˜ì.<br><br>

config/redis.js
```javascript
const redis = require('redis');

const redisClient = redis.createClient({ host: '127.0.0.1', port: process.env.REDIS_PORT, db: 0 });

redisClient.on('connect', () => {
  console.log('redis client connected');
});

module.exports = redisClient;
```

redis ì„œë²„ì— ì ‘ê·¼í•  clientë¥¼ ë§Œë“¤ì–´ì£¼ì.<br><br>

ì„œë²„ ì‹¤í–‰ í™˜ê²½ì—ì„œëŠ” ë‹¤ìŒê³¼ ê°™ì´ redis-serverì™€ redis-cliê°€ ì‹¤í–‰ ê°€ëŠ¥í•´ì•¼ í•œë‹¤.(ì´ ë¶€ë¶„ì€ ìƒëµí•˜ê² ë‹¤.)
![redis-server](/assets/img/movester/redis-server.png)<br>

<br><br>

### redisì— refreshToken ì €ì¥í•˜ê¸°

modules/redis.js
```javascript
const redisClient = require('../config/redis');

const get = idx =>
  new Promise((resolve, reject) => {
    redisClient.get(idx, (err, data) => {
      if (err) reject(err);
      resolve(data);
    });
  });

const set = (idx, token) => redisClient.set(idx, token);

const del = idx => redisClient.del(idx);

module.exports = {
  get,
  set,
  del,
};
```

redisëŠ” ë¡œê·¸ì¸ ë¡œì§ê³¼ ì¸ì¦ ë¯¸ë“¤ì›¨ì–´ ë¡œì§ì—ì„œ ì‚¬ìš©ë˜ë¯€ë¡œ modulesë¡œ ë³„ë„ ë¶„ë¦¬í•´ë†“ì•˜ë‹¤.<br>
ì´ ë‹¨ê³„ì—ì„œëŠ” setë§Œ ì§‘ì¤‘í•˜ì.âœ¨<br><br>

service/admin.js
```javascript
// login logic ...
 const token = {
      accessToken: await jwt.signAccessToken({ idx: admin.admin_idx, email: admin.email }),
      refreshToken: await jwt.signRefreshToken({ idx: admin.admin_idx, email: admin.email }),
    };

    redis.set(admin.admin_idx, token.refreshToken);
```

ë¡œê·¸ì¸ ê³¼ì •ì—ì„œ, JWTë¥¼ ì‚¬ìš©í•´ í† í°ì„ ë°œê¸‰ë°›ê³ , í•´ë‹¹ í† í°ì„ `{adminIdx: refreshToken}` í˜•íƒœë¡œ redisì— ì €ì¥í•œë‹¤.<br><br>

adminIdx ê°€ 8ì¸ ì‚¬ìš©ìê°€ ë¡œê·¸ì¸í•˜ë©´, ë‹¤ìŒê³¼ ê°™ì´ redis serverì— 8-refreshTokenì´ ì €ì¥ëœ ê²ƒì„ í™•ì¸ í•  ìˆ˜ ìˆë‹¤.
![redis-get](/assets/img/movester/redis-get.png)<br><br><br>

### redisì—ì„œ refreshToken ê°€ì ¸ì˜¤ê¸°

modules/redis.js
```javascript
...ìƒëµ

const get = idx =>
  new Promise((resolve, reject) => {
    redisClient.get(idx, (err, data) => {
      if (err) reject(err);
      resolve(data);
    });
  });

...ìƒëµ
```

`redisClient.get(key)`ë¥¼ í†µí•´ redisì— ì €ì¥ëœ keyê°’ì„ ê°€ì ¸ì˜¬ ìˆ˜ ìˆë‹¤.<br>
getì€ ë¹„ë™ê¸° í•¨ìˆ˜ì´ê¸° ë•Œë¬¸ì—, ì½œë°±í•¨ìˆ˜ì˜ dataì— ìš°ë¦¬ê°€ ì›í•˜ëŠ” refreshTokenì´ ë‹´ê²¨ìˆê³ ,<br>
í•´ë‹¹ í•¨ìˆ˜ì—ì„œ refreshTokenì„ return í•´ì£¼ê¸° ìœ„í•´ promiseë¥¼ ì‚¬ìš©í•˜ì˜€ë‹¤.<br><br>

middleware/auth.js
```javascript
// access ë§Œë£Œ refesh ìœ íš¨
    const redisToken = await redis.get(refreshToken.idx);

    if (req.cookies.refreshToken !== redisToken) {
      return res.status(CODE.UNAUTHORIZED).json(form.fail(MSG.TOKEN_INVALID));
    }

    const newAccessToken = await jwt.signAccessToken({ idx: refreshToken.idx, email: refreshToken.email });
```

accessTokenì´ ë§Œë£Œë˜ê³ , refreshTokenì€ ìœ íš¨í•  ë•Œ (JWT ê²€ì¦ìƒ), ì„œë²„ì—ì„œ ì €ì¥í•˜ê³  ìˆëŠ” refreshToken ê°’ê³¼ë„ ë™ì¼í•œì§€ ê²€ì‚¬í•œë‹¤.<br>
redis ì„œë²„ì— ì €ì¥í•˜ê³  ìˆìœ¼ë¯€ë¡œ, modulesì—ì„œ ë§Œë“  get í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ redisTokenì„ ê°€ì ¸ì˜¤ê³ ,<br>
redisTokenê³¼ ì¿ í‚¤ë¡œ ì „ë‹¬ë°›ì€ refreshTokenì´ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸í•œë‹¤.<br><br>

### redisì—ì„œ refreshToken ì‚­ì œí•˜ê¸°

ë¡œê·¸ì•„ì›ƒì‹œì—, redisì— ì €ì¥ëœ refreshTokenì„ ì‚­ì œì‹œì¼œì¤˜ì•¼ í•œë‹¤.<br>

modules/redis.js
```javascript
const del = idx => redisClient.del(idx);
```

`redisClient.del(key)` ë¥¼ í†µí•´ redis serverì—ì„œ keyê°’ì— í•´ë‹¹í•˜ëŠ” ë°ì´í„°ë¥¼ ì‚­ì œí•œë‹¤.

controller/admin.js
```javascript
const logout = async (req, res) => {
  redis.del(req.cookies.idx);
  res.clearCookie('accessToken').clearCookie('refreshToken').status(CODE.OK).json(form.success(MSG.LOGOUT_SUCCESS));
};
```

ë¡œê·¸ì•„ì›ƒì‹œ, redis-serverì—ì„œ ì‚­ì œë˜ì–´ í•´ë‹¹ keyê°’ìœ¼ë¡œ ì¡°íšŒë˜ì§€ ì•ŠëŠ”ë‹¤.<br>
![redis-del](/assets/img/movester/redis-del.png)<br>