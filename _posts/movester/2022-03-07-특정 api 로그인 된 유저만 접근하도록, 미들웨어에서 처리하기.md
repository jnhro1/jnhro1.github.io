---
layout: post
title: "API : ë¡œê·¸ì¸ ëœ ìœ ì €ë§Œ ì ‘ê·¼í•˜ë„ë¡, ë¯¸ë“¤ì›¨ì–´ì—ì„œ ì²˜ë¦¬í•˜ê¸°"
subtitle: "api"
categories: MOVESTER
tags: BACKEND
comments: true
---



<br>

## ì´ë²ˆ ê³ ë¯¼ì€?

movesterëŠ” ê´€ë¦¬ì í˜ì´ì§€ì¸ backofficeì™€ ì‚¬ìš©ì í˜ì´ì§€ì¸ product ë‘ ê°œì˜ ì›¹ì‚¬ì´íŠ¸ê°€ ì¡´ì¬í•œë‹¤.

backofficeëŠ” ëª¨ë“  apiê°€ ê´€ë¦¬ì ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸ë˜ì–´ ìˆì–´ì•¼ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆì–´ì•¼ í•˜ê¸° ë•Œë¬¸ì—,

ëª¨ë“  apiì—ì„œ ë¡œê·¸ì¸ ëœ ìœ ì €ê°€ ë³´ë‚¸ apiì¸ì§€ë¥¼ í™•ì¸í•´ì•¼ í•œë‹¤.<br><br>

ë¡œê·¸ì¸ ê³¼ì •ì—ì„œ accessTokenê³¼ refreshTokenì„ ì¿ í‚¤ì— ë‹´ì•„ ë³´ë‚´ì¤¬ê¸° ë•Œë¬¸ì—,

apië¥¼ ìš”ì²­í•œ ì‚¬ëŒì˜ ì¿ í‚¤ì—ì„œ í•´ë‹¹ í† í°ë“¤ì„ ì‚´í´ë³´ë©´ ëœë‹¤.<br><br>

ê·¸ë ‡ë‹¤ë©´ ì—¬ê¸°ì„œ ê³ ë¯¼ì´ ìƒê¸´ë‹¤.

í•´ë‹¹ ê³¼ì •ì„ ì–´ë””ì„œ ì²˜ë¦¬í•˜ì§€?<br><br>

api ì‚¬ìš© ê¶Œí•œ ì²´í¬ë¥¼

1. ê° ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ì²˜ë¦¬í• ê¹Œ?
2. ë¯¸ë“¤ì›¨ì–´ì—ì„œ ê¶Œí•œ ì²´í¬ë¥¼ ë¨¼ì € í•´ì£¼ê³  api ë¡œì§ìœ¼ë¡œ ì˜®ê²¨ì¤„ê¹Œ?

<br>

## ì„ íƒí•œ ë°©ì‹

ë¯¸ë“¤ì›¨ì–´ì—ì„œ ì²˜ë¦¬í•´ì£¼ê³  ê¶Œí•œì´ ì—†ë‹¤ë©´ api ì‹¤íŒ¨, ê¶Œí•œ ìˆìœ¼ë©´ í•´ë‹¹ api ë¡œì§ìœ¼ë¡œ ì´ë™(ì»¨íŠ¸ë¡¤ëŸ¬ í˜¸ì¶œ)ë¡œ ê²°ì •í•˜ì˜€ë‹¤.

<br>

## ì„ íƒí•œ ì´ìœ 

1. backoffice ì²˜ëŸ¼ ëª¨ë“  apiê°€ í•´ë‹¹ ë¡œì§ì„ ê±°ì³ì•¼í•˜ëŠ” ìƒí™©ì—ì„œ, ëª¨ë“  apië³„ë¡œ ê° ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ê¶Œí•œ ì²´í¬ê°€ ë“¤ì–´ê°„ë‹¤ë©´, ì¤‘ë³µì½”ë“œê°€ ë„ˆë¬´ ë§ì´ ë°œìƒí•œë‹¤.
2. 1ê³¼ ê°™ì€ ë¶ˆí¸í•¨ì´ ë¯¸ë“¤ì›¨ì–´ê°€ ì¡´ì¬í•˜ëŠ” ì´ìœ ë¼ê³  ìƒê°í•œë‹¤. api ì‚¬ìš© ì „, ë¯¸ë“¤ì›¨ì–´ì—ì„œ ì²˜ë¦¬í•˜ì—¬ api ì‚¬ìš© ê¶Œí•œì„ ì •í•´ì£¼ëŠ” ê²ƒì´ ë§ë‹¤ê³  ìƒê°í–ˆë‹¤.

<br>

## ì½”ë“œë¡œ ë³´ê¸°

```javascript
// middleware/auth
const checkToken = async (req, res, next) => {
  if (!req.cookies.accessToken) {
    return res.status(CODE.UNAUTHORIZED).json(form.fail(MSG.UNAUTHORIZED));
  }

  const accessToken = await jwt.verifyAccessToken(req.cookies.accessToken);
  const refreshToken = await jwt.verifyRefeshToken(req.cookies.refreshToken);

  if (accessToken === TOKEN_INVALID || refreshToken === TOKEN_INVALID) {
    return res.status(CODE.UNAUTHORIZED).json(form.fail(MSG.UNAUTHORIZED));
  }
  if (accessToken === TOKEN_EXPIRED) {
    if (refreshToken === TOKEN_EXPIRED) {
      // access ë§Œë£Œ refesh ë§Œë£Œ
      return res.status(CODE.UNAUTHORIZED).json(form.fail(MSG.UNAUTHORIZED));
    }
    // access ë§Œë£Œ refesh ìœ íš¨
    const redisToken = await redis.get(refreshToken.idx);

    if (req.cookies.refreshToken !== redisToken) {
      return res.status(CODE.UNAUTHORIZED).json(form.fail(MSG.TOKEN_INVALID));
    }

    const newAccessToken = await jwt.signAccessToken({ idx: refreshToken.idx, email: refreshToken.email });

    res.cookie('accessToken', newAccessToken);
    req.cookies.accessToken = newAccessToken;

    next();
  } else if (refreshToken === TOKEN_EXPIRED) {
    // access ìœ íš¨ refesh ë§Œë£Œ

    const newRefreshToken = await jwt.signRefreshToken({ idx: accessToken.idx, email: accessToken.email });

    redis.set(accessToken.idx, newRefreshToken);
    res.cookie('refreshToken', newRefreshToken);
    req.cookies.refreshToken = newRefreshToken;

    next();
  } else {
    // access ìœ íš¨ refesh ìœ íš¨
    req.cookies.userIdx = accessToken.idx;
    next();
  }
};
```
<br>

```javascript
// routes/user
router.post('/join', Validator.join, ValidatorError.err, userCtrl.join);
router.post('/login', Validator.login, ValidatorError.err, userCtrl.login);
router.get('/logout', auth.checkToken, userCtrl.logout);
```

ë‹¤ìŒê³¼ ê°™ì´ ë¯¸ë“¤ì›¨ì–´ë¡œ `auth/checkToken`ì„ ì‘ì„±í•´ë†“ê³ ,

ë¡œê·¸ì¸ ëœ ì‚¬ìš©ìë§Œ ì ‘ê·¼ ê°€ëŠ¥í•œ apiëŠ” ë¯¸ë“¤ì›¨ì–´ì— `auth.checkToken`ì„ ë„£ì–´ë‘ì—ˆë‹¤.<br><br>

ì‚¬ìš©í•´ë³´ë‹ˆ ê¸°ëŒ€í•˜ì§€ ì•Šì•˜ë˜ ì¢‹ì€ ì ì„ ë°œê²¬í–ˆëŠ”ë°,

`accessToken`ì„ `jwt`ë¡œ ì•”í˜¸í™”í• ë•Œ, `userIdx`ë¥¼ ë„£ì–´ë†¨ëŠ”ë°, ê·¸ë ‡ê²Œ í•˜ë‹¤ë³´ë‹ˆ, `auth.checkToken`ì„ ê±°ì¹˜ë©´, path param, query, body ê°’ìœ¼ë¡œ `userIdx`ë¥¼ ë°›ì§€ ì•Šì•„ë„, ë°”ë¡œ ìš”ì²­í•œ ìœ ì €ì˜ `userIdx`ë¥¼ ì•Œì•„ë‚¼ ìˆ˜ ìˆì—ˆë‹¤.

ê·¸ë˜ì„œ `userIdx` ì •ë³´ê°€ í•„ìš”í•œ apiëŠ” payloadë¡œ í•´ë‹¹ ë°ì´í„°ë¥¼ ë³„ë„ë¡œ ë°›ì§€ ì•Šê³ , ì¿ í‚¤ë¥¼ íŒŒì‹±í•˜ì—¬ ê°’ì„ ë¯¸ë“¤ì›¨ì–´ì—ì„œ ì»¨íŠ¸ë¡¤ëŸ¬ë¡œ ë³´ë‚´ì£¼ì–´ ë°ì´í„°ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆì—ˆë‹¤ğŸ¥³ğŸ¥³